<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Just2Numbers.com</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.19.0/proj4.min.js"></script>
    <script src="os-transform.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="container">
    <div class="image-container">
        <img src="Just2Numbers.jpeg" alt="Just2Numbers Image">
    </div>
    <h1>Just2Numbers</h1>
    <div class="location" id="location">Fetching location...</div>
    <button class="copy-button" id="copyButton" onclick="copyLocation()" style="display:none;">Copy Location</button>
    <div>
    <button onclick="getLocation()">Refresh Location</button>
    </div>
    <br>
    <div>
        Just2Numbers provides a simple web interface to show the current location in an open and flexible format. 
        Clickable links are provided to allow location data to be displayed or shared via various different mechanisms such as WhatsApp, Facebook etc.<br>
        Privacy: Just2Numbers runs code in the browser and is entirely static content. Just2Numbers does not currently use cookies. Just2Numbers does not see or collect any location data from end users.<br>
        <a class="link" href="https://www.Just2Numbers.com" target="_blank">Just2Numbers Home</a>
    </div>
</div>

<script>
    function isLocationInUK(lat, long) {
        const northernmost = 60.847;
        const southernmost = 49.959;
        const westernmost = -8.649;
        const easternmost = 1.768;

        return lat <= northernmost && lat >= southernmost && long <= easternmost && long >= westernmost;
    }


    function latLongToGridRef(lat, long) {
        const wgs84 = '+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs';
        const osgb36 = '+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.999601 +x_0=400000 +y_0=-100000 +ellps=airy +towgs84=446.448,-125.157,542.060,0.1502,0.2470,0.8421,-20.4894 +units=m +no_defs';
        const [easting, northing] = proj4(wgs84, osgb36, [long, lat]);
        const gridRef = os.Transform.toGridRef({ ea: easting, no: northing });
        return gridRef.text;
    }



    function getLocation() {
        options = {
          enableHighAccuracy: true,
          timeout: 20000,
          maximumAge: 0
        };        
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                showPosition,
                showError,
                options );
        } else {
            document.getElementById("location").innerHTML = "Geolocation is not supported by this browser.";
        }
    }


    function showPosition(position) {
        const lat = position.coords.latitude;
        const long = position.coords.longitude;
        const accuracy = position.coords.accuracy; // in meters
        const timestamp = position.timestamp; // in milliseconds
        const posAge = Date.now() - timestamp;
        const latStr = lat.toFixed(6);      
        const longStr = long.toFixed(6);      
        const locationTextLabel = `Latitude, Longitude:`;
        const locationText = `${latStr}, ${longStr}`;
        const commaDelimited = `${lat},${long}`;
        ukLoc = isLocationInUK( lat, long );
        UKGridRefText = "";
        UKMsgNewLine ="";
        UKHtmlNewLine ="";
        if (ukLoc )
        {
            gridRef = latLongToGridRef(lat, long);
            UKGridRefText = 'UK Grid Ref: ' + gridRef;
            UKMsgNewLine = "\n\n";
            UKHtmlNewLine = "<br>";
            // fullLocationText += '\n' + 'UK Grid Ref: ' + gridRef;
        }
        
        myDate = new Date(timestamp);
        // Formatting options
        const options = {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true // Set to true for 12-hour format
        };
        const formattedDate = date.toLocaleString('en-US', options).replace(',', ''); 

        inaccurate = false;
        greyTextStyle = ``;
        // If the accuracy is out or the age is old then go get it again...
        if ( accuracy > 10 || posAge > 1000*60 ) {
            inaccurate = true;
            greyTextStyle = `style='color: grey;'`;
        }

        const googleMapsText = 'https://www.google.com/maps?q=' + commaDelimited;
        const fullLocationText = 'Latitude, Longitude:\n' + commaDelimited + '\n\n' + 'Accuracy ' + accuracy.toFixed(2) + '\n\n' + formattedDate + '\n\n' + googleMapsText + UKMsgNewLine + UKGridRefText + '\n\n' + 'Position Data From https://www.Just2Numbers.com';
        document.getElementById("location").innerHTML = locationTextLabel + "<br>" + locationText;
        if (ukLoc )
        {
            document.getElementById("location").innerHTML += UKHtmlNewLine + UKGridRefText;
        }
        document.getElementById("location").innerHTML += UKHtmlNewLine + 'Accuracy ' + accuracy.toFixed(2);
        document.getElementById("location").innerHTML += UKHtmlNewLine + 'Time ' + formattedDate;

        const googleMapsLink = `https://www.google.com/maps/?=${lat},${long},17z`;
        const bingMapsLink = `https://www.bing.com/maps?cp=${lat}~${long}&lvl=17.0`;
        const megpMapsLink = `https://www.megalithic.co.uk/le_megalith_map_os.html#10/${lat}/${long}`;


        document.getElementById("location").innerHTML += `
            <p style=${greyTextStyle}>
            <a class="link" href="${googleMapsLink}" target="_blank">View on Google Maps</a>
            <a class="link" href="${megpMapsLink}" target="_blank">View on Megalithic Portal Maps</a>
            <a class="link" href="sms:?body=${encodeURIComponent(fullLocationText)}">Send via SMS</a>
            <a class="link" href="mailto:?subject=My Location&body=${encodeURIComponent(fullLocationText)}">Send via Email</a>
            <a class="link" href="https://wa.me/?text=${encodeURIComponent(fullLocationText)}" target="_blank">Share on WhatsApp</a>
            <a class="link" href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(fullLocationText)}" target="_blank">Share on Facebook</a>
            </p>
        `;


        // Show the copy button
        const copyButton = document.getElementById("copyButton");
        copyButton.style.display = "block";
        copyButton.setAttribute("data-clipboard-text", commaDelimited);

        if ( inaccurate) {
            getLocation();
        }
    }

    function copyLocation() {
        const lat = document.getElementById("location").innerText.match(/^Latitude,\s*Longitude:\s*([-+]?\d*\.\d+),\s*([-+]?\d*\.\d+)/);
        if (lat) {
            const commaDelimited = `${lat[1]}, ${lat[2]}`;
            navigator.clipboard.writeText(commaDelimited).then(() => {
                alert("Location copied");
            }).catch(err => {
                console.error("Failed to copy: ", err);
            });
        }
    }


    function showError(error) {
        switch(error.code) {
            case error.PERMISSION_DENIED:
                document.getElementById("location").innerHTML = "User denied the request for Geolocation.";
                break;
            case error.POSITION_UNAVAILABLE:
                document.getElementById("location").innerHTML = "Location information is unavailable.";
                break;
            case error.TIMEOUT:
                document.getElementById("location").innerHTML = "The request to get user location timed out.";
                break;
            case error.UNKNOWN_ERROR:
                document.getElementById("location").innerHTML = "An unknown error occurred.";
                break;
        }
    }

    window.onload = getLocation;
</script>    

</body>
</html>
